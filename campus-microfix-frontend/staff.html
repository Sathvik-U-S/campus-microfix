<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Dashboard – Campus MicroFix</title>
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
    }
    header {
      background: #111827; /* Dark Gray/Black header */
      color: white;
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header a {
      color: #d1d5db;
      text-decoration: none;
      margin-left: 18px;
      font-size: 15px;
      font-weight: 500;
      transition: color 0.2s;
    }
    header a:hover {
        color: white;
    }
    main {
      max-width: 1200px;
      margin: 32px auto;
      background: white;
      padding: 30px 35px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
    }
    h1 {
      margin-top: 0;
      color: #1f2937;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 10px;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      align-items: center;
      padding: 15px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    label {
        font-weight: 600;
        font-size: 14px;
        color: #374151;
    }
    select, input[type="text"] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      min-width: 150px;
    }
    input[type="text"] {
        border-radius: 999px;
        min-width: 200px;
    }
    select:focus, input[type="text"]:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px #bfdbfe;
        outline: none;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      background: #2563eb;
      color: white;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
        background: #1d4ed8;
    }
    button:disabled {
      background: #9ca3af;
      cursor: default;
    }
    table {
      width: 100%;
      border-collapse: separate; /* Use separate for border-spacing */
      border-spacing: 0 5px; /* Add space between rows */
      font-size: 14px;
      margin-top: 15px;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 10px 8px;
      text-align: left;
    }
    th {
      font-size: 12px;
      text-transform: uppercase;
      color: #6b7280;
      background: #f9fafb;
      font-weight: 600;
    }
    tr.issueRow {
      cursor: pointer;
      background: white;
      border: 1px solid #f3f4f6;
      border-radius: 8px; /* Does not work on tr, but helps visual */
      transition: background 0.15s;
    }
    tr.issueRow:hover {
      background: #eff6ff; /* Light blue on hover */
    }
    /* Apply rounded corners to cells in the row */
    tr.issueRow td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
    tr.issueRow td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    /* Statuses */
    .status-open { background:#fee2e2;color:#b91c1c; }
    .status-inprogress { background:#dbeafe;color:#1d4ed8; }
    .status-resolved { background:#dcfce7;color:#059669; }
    /* Priorities */
    .priority-low { background:#e5e7eb;color:#374151; }
    .priority-medium { background:#fef08a;color:#a16207; }
    .priority-high { background:#fecaca;color:#b91c1c; }
    .priority-critical { background:#fce7f3;color:#be185d; } /* New Critical Color */

    .analytics {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
      margin-bottom: 15px;
    }
    .card {
      padding: 18px 20px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      font-size: 16px;
      min-width: 180px;
      flex: 1;
      transition: all 0.2s;
    }
    .card:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        transform: translateY(-2px);
    }
    .card strong {
      display:block;
      font-size:12px;
      text-transform:uppercase;
      color:#6b7280;
      margin-bottom:6px;
      font-weight: 700;
    }
    .card span {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
    }
    #totalOpen { color: #b91c1c; }
    #highCount { color: #be185d; }
    #resolvedCount { color: #059669; }

    .msg {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    /* Detail panel under the table */
    .detail-panel {
      margin-top: 25px;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #a5b4fc; /* Distinct border */
      background: #eef2ff; /* Light indigo background */
      font-size: 14px;
    }
    .detail-panel h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #4f46e5;
      border-bottom: 1px solid #c7d2fe;
      padding-bottom: 8px;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px 20px;
      margin-top: 10px;
    }
    .detail-label {
      font-size: 11px;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 4px;
      font-weight: 700;
    }
    .detail-value {
      font-size: 14px;
      color: #111827;
      font-weight: 500;
    }
    .detail-reason {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e0e7ff;
      font-size: 13px;
      color: #374151;
    }
    .detail-reason strong {
      text-transform: none;
      font-size: 13px;
    }
  </style>
</head>
<body>
<header>
  <div>Campus MicroFix – Department Dashboard</div>
  <nav>
    <a href="index.html">Home</a>
    <a href="report.html">Report Issue</a>
    <a href="student.html">Student Status</a>
  </nav>
</header>

<main>
  <h1>Staff Dashboard</h1>
  <p class="msg">
    Select your department to view and manage assigned micro-issues.
  </p>
  <p class="msg" style="font-weight: 600;">
    Current staff access: <span id="staffAccessStatus" style="color: #4f46e5;">Not verified</span>
  </p>

  <p class="msg" style="margin-top: 15px;">
    <strong style="color:#1f2937;">Category Guide:</strong>
    <span class="badge status-inprogress">IT</span> – Wi-Fi, projector, systems ·
    <span class="badge status-resolved">Maintenance</span> – desks, chairs, AC, lights, leaks ·
    <span class="badge status-open">Admin</span> – markers, cleaning, timetables, forms
  </p>

  <div class="filters">
    <label>Department:
      <select id="deptSelect">
        <option value="IT">IT</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Admin">Admin</option>
      </select>
    </label>

    <label>Status:
      <select id="statusFilter">
        <option value="">All</option>
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Resolved">Resolved</option>
      </select>
    </label>

    <label>Priority:
      <select id="priorityFilter">
        <option value="">All</option>
        <option value="Critical">Critical</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
      </select>
    </label>

    <input type="text" id="searchInput" placeholder="Search title/description" />
    <button id="loadBtn">Load Issues</button>
    <span id="statusText" class="msg" style="margin: 0; font-style: italic;"></span>
  </div>

  <div class="analytics">
    <div class="card">
      <strong>Total Open Issues</strong>
      <span id="totalOpen">0</span>
    </div>
    <div class="card">
      <strong>High & Critical Priority</strong>
      <span id="highCount">0</span>
    </div>
    <div class="card">
      <strong>Resolved This Period</strong>
      <span id="resolvedCount">0</span>
    </div>
  </div>

  <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th style="border-top-left-radius: 8px;">Title</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Location</th>
          <th>Reported By</th>
          <th>Updated</th>
          <th style="border-top-right-radius: 8px;">Change Status</th>
        </tr>
      </thead>
      <tbody id="issuesBody">
        </tbody>
    </table>
  </div>

  <div id="detailPanel" class="detail-panel" style="display:none;">
    <h2>Issue Details</h2>
    <div class="detail-grid">
      <div>
        <div class="detail-label">Title</div>
        <div id="detailTitle" class="detail-value">-</div>
      </div>
      <div>
        <div class="detail-label">Category</div>
        <div id="detailCategory" class="detail-value">-</div>
      </div>
      <div>
        <div class="detail-label">Priority</div>
        <div id="detailPriority" class="detail-value">-</div>
      </div>
      <div>
        <div class="detail-label">Status</div>
        <div id="detailStatus" class="detail-value">-</div>
      </div>
      <div>
        <div class="detail-label">Location</div>
        <div id="detailLocation" class="detail-value">-</div>
      </div>
      <div>
        <div class="detail-label">Reported By</div>
        <div id="detailReportedBy" class="detail-value">-</div>
      </div>
      <div>
        <div class="detail-label">Updated At</div>
        <div id="detailUpdatedAt" class="detail-value">-</div>
      </div>
    </div>

    <div class="detail-reason" id="detailClassReason">
      </div>
    <div class="detail-reason" id="detailPriorityReason">
      </div>

    <div class="detail-reason">
      <div class="detail-label">Description</div>
      <span id="detailDescription" class="detail-value" style="color: #374151;"></span>
    </div>
  </div>
</main>

<script>
const API_BASE = "https://campus-microfix-backend.onrender.com/api";


const deptSelect = document.getElementById("deptSelect");
const statusFilter = document.getElementById("statusFilter");
const priorityFilter = document.getElementById("priorityFilter");
const searchInput = document.getElementById("searchInput");
const statusText = document.getElementById("statusText");
const tbody = document.getElementById("issuesBody");

const totalOpenEl = document.getElementById("totalOpen");
const highCountEl = document.getElementById("highCount");
const resolvedCountEl = document.getElementById("resolvedCount");

// Detail panel elements
const detailPanel = document.getElementById("detailPanel");
const detailTitle = document.getElementById("detailTitle");
const detailCategory = document.getElementById("detailCategory");
const detailPriority = document.getElementById("detailPriority");
const detailStatus = document.getElementById("detailStatus");
const detailLocation = document.getElementById("detailLocation");
const detailReportedBy = document.getElementById("detailReportedBy");
const detailUpdatedAt = document.getElementById("detailUpdatedAt");
const detailDescription = document.getElementById("detailDescription");
const detailClassReason = document.getElementById("detailClassReason");
const detailPriorityReason = document.getElementById("detailPriorityReason");

let currentIssues = [];
let staffKey = null; // from prompt

function statusBadge(status) {
  const s = (status || "").toLowerCase();
  if (s === "in progress") return '<span class="badge status-inprogress">In Progress</span>';
  if (s === "resolved") return '<span class="badge status-resolved">Resolved</span>';
  return '<span class="badge status-open">Open</span>';
}

function priorityBadge(priority) {
  const p = (priority || "").toLowerCase();
  if (p === "critical") return '<span class="badge priority-critical">Critical</span>';
  if (p === "high") return '<span class="badge priority-high">High</span>';
  if (p === "medium") return '<span class="badge priority-medium">Medium</span>';
  return '<span class="badge priority-low">Low</span>';
}

function applyFilters() {
  const statusVal = statusFilter.value;
  const priorityVal = priorityFilter.value;
  const searchVal = searchInput.value.toLowerCase();

  const filtered = currentIssues.filter(issue => {
    if (statusVal && issue.status !== statusVal) return false;
    if (priorityVal && issue.priority !== priorityVal) return false;
    if (searchVal) {
      const text = `${issue.title} ${issue.description || ""}`.toLowerCase();
      if (!text.includes(searchVal)) return false;
    }
    return true;
  });

  renderTable(filtered);
  updateAnalytics(filtered);
}

function renderTable(issues) {
  tbody.innerHTML = issues.map(issue => `
    <tr class="issueRow" data-id="${issue._id}">
      <td>${issue.title}</td>
      <td>${priorityBadge(issue.priority)}</td>
      <td>${statusBadge(issue.status)}</td>
      <td>${issue.locationText || "-"}</td>
      <td>${issue.reportedBy || "-"}</td>
      <td>${issue.updatedAt ? new Date(issue.updatedAt).toLocaleString() : "-"}</td>
      <td>
        <select data-id="${issue._id}" class="statusSelect" onclick="event.stopPropagation();">
          <option value="Open" ${issue.status === "Open" ? "selected" : ""}>Open</option>
          <option value="In Progress" ${issue.status === "In Progress" ? "selected" : ""}>In Progress</option>
          <option value="Resolved" ${issue.status === "Resolved" ? "selected" : ""}>Resolved</option>
        </select>
      </td>
    </tr>
  `).join("");

  // Row click → show details
  document.querySelectorAll(".issueRow").forEach(row => {
    row.addEventListener("click", () => {
      const id = row.getAttribute("data-id");
      const issue = currentIssues.find(i => i._id === id);
      if (issue) {
        showDetails(issue);
      }
    });
  });

  // Status dropdown change → updateStatus
  document.querySelectorAll(".statusSelect").forEach(select => {
    select.addEventListener("change", async (e) => {
      const id = e.target.getAttribute("data-id");
      const newStatus = e.target.value;
      await updateStatus(id, newStatus);
    });
  });
}

function updateAnalytics(issues) {
  const open = issues.filter(i => i.status === "Open").length;
  const resolved = issues.filter(i => i.status === "Resolved").length;
  const high = issues.filter(i => ["High", "Critical"].includes(i.priority)).length;

  totalOpenEl.textContent = open;
  resolvedCountEl.textContent = resolved;
  highCountEl.textContent = high;
}

function showDetails(issue) {
  detailTitle.textContent = issue.title || "-";
  detailCategory.textContent = issue.category || "-";
  detailPriority.textContent = issue.priority || "-";
  detailStatus.textContent = issue.status || "-";
  detailLocation.textContent = issue.locationText || "-";
  detailReportedBy.textContent = issue.reportedBy || "-";
  detailUpdatedAt.textContent = issue.updatedAt ? new Date(issue.updatedAt).toLocaleString() : "-";
  detailDescription.textContent = issue.description || "-";

  detailClassReason.innerHTML =
    `<div class="detail-label">Category Reasoning</div>
     <div class="detail-value">${issue.classificationReason || "No details available."}</div>`;

  detailPriorityReason.innerHTML =
    `<div class="detail-label">Priority Reasoning</div>
     <div class="detail-value">${issue.priorityReason || "No details available."}</div>`;

  detailPanel.style.display = "block";
}

async function loadIssues() {
  const dept = deptSelect.value;
  statusText.textContent = "Loading issues...";
  tbody.innerHTML = "";
  totalOpenEl.textContent = "0";
  highCountEl.textContent = "0";
  resolvedCountEl.textContent = "0";
  detailPanel.style.display = "none";

  try {
    const res = await fetch(`${API_BASE}/issues?department=${encodeURIComponent(dept)}`);
    const data = await res.json();
    currentIssues = Array.isArray(data) ? data : [];
    if (currentIssues.length === 0) {
      statusText.textContent = "No issues assigned to this department.";
    } else {
      statusText.textContent = `Loaded ${currentIssues.length} issue(s). Click a row to view details.`;
    }
    applyFilters();
  } catch (err) {
    console.error(err);
    statusText.textContent = "Failed to load issues.";
  }
}

async function updateStatus(id, newStatus) {
  // Check if a key was entered. If not, prevent status change.
  if (!staffKey) {
    alert("Please refresh and enter a staff access code to enable status changes.");
    // Revert select back to original status if possible
    const originalIssue = currentIssues.find(i => i._id === id);
    if (originalIssue) {
        document.querySelector(`.statusSelect[data-id="${id}"]`).value = originalIssue.status;
    }
    statusText.textContent = "Status change failed: Staff access key is missing.";
    return;
  }
  
  try {
    const headers = {
      "Content-Type": "application/json"
    };

    // Attach staff key
    headers["x-staff-key"] = staffKey;

    const res = await fetch(`${API_BASE}/issues/${id}`, {
      method: "PATCH",
      headers,
      body: JSON.stringify({ status: newStatus })
    });

    const data = await res.json();

    if (!res.ok) {
      // Revert select back to original status if update failed
      const originalIssue = currentIssues.find(i => i._id === id);
      if (originalIssue) {
          document.querySelector(`.statusSelect[data-id="${id}"]`).value = originalIssue.status;
      }
      
      if (res.status === 403) {
        statusText.textContent = "Status change failed: Invalid or missing staff access code.";
      } else {
        statusText.textContent = `Status change failed: ${data.error || "Server error."}`;
      }
      console.error("Failed to update status", data);
      return;
    }

    statusText.textContent = `✅ Status updated to "${newStatus}".`;

    const idx = currentIssues.findIndex(i => i._id === id);
    if (idx !== -1) {
      currentIssues[idx] = data;
      applyFilters();
      // If this issue is shown in details, update detail panel as well
      if (detailPanel.style.display !== 'none' && detailTitle.textContent === data.title) {
          showDetails(currentIssues[idx]);
      }
    }
  } catch (err) {
    console.error(err);
    statusText.textContent = "Status change failed: Network or unexpected error.";
  }
}

document.getElementById("loadBtn").addEventListener("click", loadIssues);
statusFilter.addEventListener("change", applyFilters);
priorityFilter.addEventListener("change", applyFilters);
searchInput.addEventListener("input", applyFilters);

// Ask for staff key and load default department on page load
window.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("staffAccessStatus");

  staffKey = window.prompt("Enter staff access code to enable status changes:", "");

  if (!staffKey) {
    statusEl.textContent = "No access code entered (view-only mode)";
    statusEl.style.color = "#b91c1c"; /* Red for non-verified */
  } else {
    statusEl.textContent = "Access code verified (status changes enabled)";
    statusEl.style.color = "#059669"; /* Green for verified */
  }

  loadIssues();
});
</script>
</body>
</html>