<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Report Issue – Campus MicroFix</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
    }
    header {
      background: #1f2937;
      color: white;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header a {
      color: #e5e7eb;
      text-decoration: none;
      margin-left: 12px;
      font-size: 14px;
    }
    main {
      max-width: 760px;
      margin: 24px auto;
      background: white;
      padding: 24px 28px;
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    }
    h1 {
      margin-top: 0;
    }
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    input[type="text"],
    input[type="email"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 90px;
    }
    .field {
      margin-bottom: 16px;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .actions {
      margin-top: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      background: #2563eb;
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .message {
      margin-top: 12px;
      font-size: 14px;
    }
    .message.success {
      color: #059669;
    }
    .message.error {
      color: #b91c1c;
    }
    .summary {
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      font-size: 14px;
    }
    small.helper {
      font-size: 12px;
      color: #6b7280;
    }
  </style>
</head>
<body>
<header>
  <div>Campus MicroFix – Report Issue</div>
  <nav>
    <a href="index.html">Home</a>
    <a href="student.html">Student Status</a>
    <a href="staff.html">Staff Dashboard</a>
  </nav>
</header>

<main>
  <h1>Report a Campus Micro-Issue</h1>
  <p style="color:#4b5563;font-size:14px;">
    Use this form for minor disruptions only: projector not working, broken desk, missing markers, empty water cooler, Wi-Fi slow in a room, etc.
  </p>

  <form id="issueForm">
    <div class="field">
      <label for="email">Your Email / ID</label>
      <input type="email" id="email" required placeholder="e.g. student1@campus.edu" />
      <small class="helper">We use this to show your issues on the tracking page.</small>
    </div>

    <div class="field">
      <label for="title">Short Title</label>
      <input type="text" id="title" required placeholder="Projector not working in C-203" />
    </div>

    <div class="field">
      <label for="description">Describe the Problem</label>
      <textarea id="description" required placeholder="What exactly is wrong? Include room number and any details."></textarea>
    </div>

    <div class="field">
      <label for="location">Location</label>
      <input type="text" id="location" required placeholder="Block C, Room 203" />
    </div>

    <div class="field">
      <div class="checkbox-row">
        <input type="checkbox" id="affectsClass" />
        <label for="affectsClass" style="margin:0;font-weight:500;">Affects an ongoing class</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="safetyRisk" />
        <label for="safetyRisk" style="margin:0;font-weight:500;">Safety risk (electric, structural, etc.)</label>
      </div>
    </div>

    <div class="actions">
      <button type="submit" id="submitBtn">Submit Issue</button>
      <span id="statusText" style="font-size:13px;color:#6b7280;"></span>
    </div>

    <div id="message" class="message" style="display:none;"></div>
    <div id="summary" class="summary" style="display:none;"></div>
  </form>
</main>

<script>
const API_BASE = "http://localhost:4000/api";

document.getElementById("issueForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const email = document.getElementById("email").value.trim();
  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const locationText = document.getElementById("location").value.trim();
  const affectsClass = document.getElementById("affectsClass").checked;
  const safetyRisk = document.getElementById("safetyRisk").checked;

  const messageEl = document.getElementById("message");
  const summaryEl = document.getElementById("summary");
  const submitBtn = document.getElementById("submitBtn");
  const statusText = document.getElementById("statusText");

  messageEl.style.display = "none";
  summaryEl.style.display = "none";

  submitBtn.disabled = true;
  statusText.textContent = "Submitting issue...";

  try {
    const res = await fetch(`${API_BASE}/issues`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title,
        description,
        locationText,
        reportedBy: email,
        affectsClass,
        safetyRisk
      })
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || "Failed to submit issue");
    }

    messageEl.textContent = "Issue submitted successfully!";
    messageEl.className = "message success";
    messageEl.style.display = "block";

    summaryEl.innerHTML = `
  <strong>Auto-classification:</strong><br/>
  Category: <b>${data.category}</b><br/>
  Priority: <b>${data.priority}</b><br/>
  Assigned Department: <b>${data.department}</b><br/>
  Assignee: <b>${data.assignee}</b><br/>
  Status: <b>${data.status}</b><br/>
  <br/>
  <strong>Why?</strong><br/>
  ${data.classificationReason || ""}<br/>
  ${data.priorityReason || ""}
`;

    summaryEl.style.display = "block";

    statusText.textContent = "You can track this issue on the Student Status page.";

    // optional: clear fields except email
    document.getElementById("title").value = "";
    document.getElementById("description").value = "";
    document.getElementById("location").value = "";
    document.getElementById("affectsClass").checked = false;
    document.getElementById("safetyRisk").checked = false;
  } catch (err) {
    messageEl.textContent = err.message;
    messageEl.className = "message error";
    messageEl.style.display = "block";
    statusText.textContent = "";
  } finally {
    submitBtn.disabled = false;
  }
});
</script>
</body>
</html>
